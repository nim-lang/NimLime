# [PackageDev] target_format: plist, ext: tmLanguage
---
name: Nim Source Code Filter
scopeName: source.nim_filter
fileTypes: ["nimf"]
patterns:
  - begin: '^ *#'
    end: '^(?! *#)'
    patterns:
      - match: '(end) (proc|func|method|template|macro|iterator|converter)\b'
        captures:
          '1': {name: keyword.control.nim_filter}
          '2': {name: storage.type.function.nim_filter}
      - include: '#main'

repository:
  main:
    patterns:
      - include: '#type-defs'
      - include: '#const-defs'
      - include: '#var-let-using-defs'
      - include: '#pragmas'
      - include: '#brackets'
      - include: '#punctuations'
      - include: '#block-doc-comments'
      - include: '#comments'
      - include: '#for-stmts'
      - include: '#asm-stmts'
      - include: '#routines'
      - include: '#fmt-strs'
      - include: '#operators'
      - include: '#literals'
      - include: '#keywords'
      - include: '#do-stmts'
      - include: '#calls'
      - include: '#types'
      - include: '#builtins'
      - include: '#generic-symbols'

  doc-comments:
    patterns:
      - include: '#block-doc-comments'
      - include: '#line-doc-comments'

  block-doc-comments:
    patterns:
      - match: '^ *#'
      - begin: '##\['
        beginCaptures:
          '0': {name: punctuation.definition.comment.begin.nim_filter}
        end: '^(?! *#)|]##'
        endCaptures:
          '0': {name: punctuation.definition.comment.end.nim_filter}
        name: comment.block.documentation.nim_filter
        patterns:
          - include: '#block-doc-comments'

  line-doc-comments:
    patterns:
      - match: '^ *#'
      - begin: '##'
        beginCaptures:
          '0': {name: punctuation.definition.comment.nim_filter}
        end: '^(?! *#)|^(?! *#)|$\n?'
        name: comment.line.documentation.nim_filter

  comments:
    patterns:
      - include: '#block-comments'
      - include: '#line-comments'

  block-comments:
    patterns:
      - match: '^ *#'
      - begin: '#\['
        beginCaptures:
          '0': {name: punctuation.definition.comment.begin.nim_filter}
        end: '^(?! *#)|]#'
        endCaptures:
          '0': {name: punctuation.definition.comment.end.nim_filter}
        name: comment.block.number-sign.nim_filter
        patterns:
          - include: '#block-comments'

  line-comments:
    patterns:
      - match: '^ #'
      - begin: '(#)(?: *(TODO|todo)\b)?'
        beginCaptures:
          '1': {name: punctuation.definition.comment.nim_filter}
          '2': {name: invalid.deprecated.nim_filter}
        end: '^(?! *#)|$\n?'
        name: comment.line.number-sign.nim_filter

  brackets:
    patterns:
      - include: '#square-brackets'
      - begin: '\{'
        beginCaptures:
          '0': {name: punctuation.section.braces.begin.nim_filter}
        end: '^(?! *#)|}'
        endCaptures:
          '0': {name: punctuation.section.braces.end.nim_filter}
        name: meta.braces.nim_filter
        patterns:
          - include: '#main'

      - begin: '\('
        beginCaptures:
          '0': {name: punctuation.section.parens.begin.nim_filter}
        end: '^(?! *#)|\)'
        endCaptures:
          '0': {name: punctuation.section.parens.end.nim_filter}
        name: meta.parens.nim_filter
        patterns:
          - include: '#main'

  square-brackets:
    patterns:
      - begin: '\['
        beginCaptures:
          '0': {name: punctuation.section.brackets.begin.nim_filter}
        end: '^(?! *#)|]'
        endCaptures:
          '0': {name: punctuation.section.brackets.end.nim_filter}
        name: meta.brackets.nim_filter
        patterns:
          - include: '#main'

  punctuations:
    patterns:
      - match: ';'
        name: punctuation.terminator.statement.nim_filter
      - match: ','
        name: punctuation.separator.nim_filter
      - match: ':'
        name: punctuation.section.block.begin.nim_filter
      - match: '\.(?![-=+*/<>@$~&%|!?^.:\\∙∘×★⊗⊘⊙⊛⊠⊡∩∧⊓±⊕⊖⊞⊟∪∨⊔])'
        name: punctuation.accessor.dot.nim_filter
      - match: '(\*) *(:|(?=,|#|\{\.))'
        captures:
          '1': {name: storage.modifier.nim_filter}
          '2': {name: punctuation.separator.annotation.nim_filter}
      - match: '\)|]|}'
        name: invalid.illegal.nim_filter

  for-stmts:
    patterns:
      - begin: for\b
        beginCaptures:
          '0': {name: keyword.control.loop.for.nim_filter}
        end: ^(?! *#)|(in\b)|(?=[^#,{_`A-Za-z\x80-\xff\s])
        endCaptures:
          '1': {name: keyword.control.loop.for.in.nim_filter}
        patterns:
          - begin: \(
            beginCaptures:
              '0': {name: punctuation.section.parens.begin.nim_filter}
            end: '^(?! *#)|(in\b)|(\))|(?=[^#,{_`A-Za-z\x80-\xff\s])'
            endCaptures:
              '1': {name: keyword.control.loop.for.in.nim_filter}
              '2': {name: punctuation.section.parens.end.nim_filter}
            patterns:
              - include: '#for-stmt-1'
          - include: '#for-stmt-1'

  for-stmt-1:
    patterns:
      - match: ','
        name: punctuation.separator.nim_filter
      - match: '[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`'
      - include: '#pragmas'
      - include: '#comments'

  asm-stmts:
    patterns:
      - begin: asm\b
        beginCaptures:
          '0': {name: keyword.control.flow.nim_filter}
        end: '^(?! *#)|(?=[^"Rr{\s])|(?<=")'
        patterns:
          - include: '#pragmas'
          - include: '#asm-stmt-1'

  asm-stmt-1:
    patterns:
      - begin: '([Rr])?(""")'
        captures:
          '1': {name: storage.type.string.nim_filter}
          '2': {name: string.quoted.triple.nim_filter punctuation.definition.string.begin.nim_filter}
        end: '^(?! *#)|"""(?!")'
        endCaptures:
          '0': {name: string.quoted.triple.nim_filter punctuation.definition.string.end.nim_filter}
        contentName: string.quoted.triple.nim_filter
        patterns:
          - include: '#interpolation'
      - begin: '([Rr])(")'
        beginCaptures:
          '1': {name: storage.type.string.nim_filter}
          '2': {name: string.quoted.double.nim_filter punctuation.definition.string.begin.nim_filter}
        end: ^(?! *#)|(")|(\n)
        endCaptures:
          '1': {name: string.quoted.double.nim_filter punctuation.definition.string.begin.nim_filter}
          '2': {name: invalid.illegal.nim_filter}
        contentName: string.quoted.double.nim_filter
        patterns:
          - include: '#interpolation'
      - begin: '"'
        beginCaptures:
          '0': {name: punctuation.definition.string.begin.nim_filter}
        end: ^(?! *#)|(")|(\n)
        endCaptures:
          '1': {name: string.quoted.double.nim_filter punctuation.definition.string.begin.nim_filter}
          '2': {name: invalid.illegal.nim_filter}
        name: string.quoted.double.nim_filter
        patterns:
          - match: '\\(?:[ABCEFLNPRTVabceflnprtv"''\\]|\d+|[Xx]\h{2}|[Uu](?:\h{4}|\{\h+}))'
            name: constant.character.escape.nim_filter
          - match: \\
            name: invalid.illegal.lone-escape.nim_filter
          - include: '#interpolation'

  interpolation:
    patterns:
      - match: '(`) *(?:[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_) *(`)'
        captures:
          '0': {name: source.nim_filter.embedded}
          '1': {name: punctuation.section.embedded.begin.nim_filter}
          '2': {name: punctuation.section.embedded.end.nim_filter}

  routines:
    patterns:
      - begin: '(?x:
          (proc|template|iterator|func|method|macro|converter)\b
          (?:[ ]*([A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`)(?:[ ]*(\*))?)?
        )'
        beginCaptures:
          '1': {name: storage.type.function.nim_filter}
          '2': {name: entity.name.function.nim_filter}
          '3': {name: storage.modifier.nim_filter}
        end: ^(?! *#)|(:)|(?=[^#\(\[:\s])
        endCaptures:
          '1': {name: punctuation.separator.annotation.nim_filter}
        name: meta.function.nim_filter
        patterns:
          - include: '#comments'
          - include: '#patterns'
          - include: '#generic-param-list'
          - include: '#param-list'

  patterns:
    patterns:
      - begin: '\{(?!\.)'
        beginCaptures:
          '0': {name: punctuation.section.pattern.begin.nim_filter}
        end: '^(?! *#)|}'
        endCaptures:
          '0': {name: punctuation.section.pattern.end.nim_filter}
        name: meta.pattern.nim_filter
        patterns:
          - include: '#main'

  param-list:
    patterns:
      - begin: '\('
        beginCaptures:
          '0': {name: punctuation.section.parameters.begin.nim_filter}
        end: '^(?! *#)|\)'
        endCaptures:
          '0': {name: punctuation.section.parameters.end.nim_filter}
        name: meta.function.parameters
        patterns:
          - match: '[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`'
            name: variable.parameter.nim_filter
          - match: '[,;]'
            name: punctuation.separator.nim_filter
          - begin: '(:)|(=)'
            beginCaptures:
              '1': {name: punctuation.separator.annotation.nim_filter}
              '2': {name: keyword.operator.assignment.nim_filter}
            end: ^(?! *#)|(?=[,;\)])
            patterns:
              - include: '#main'
          - include: '#comments'

  invalid-names:
    patterns:
      - match: '(?x:addr|asm|bind|block|break|case|cast|concept|const|continue|converter
        |defer|discard|distinct|do|elif|else|end|enum|except|export|finally|for
        |from|func|if|import|include|interface|iterator|let|macro|method|mixin
        |object|of|out|proc|ptr|raise|ref|return|static|template|try|tuple|type
        |using|var|when|while|yield)\b'
        name: invalid.illegal.nim_filter

  fmt-strs:
    patterns:
      - begin: '(?:(fmt)|(&))(""")'
        beginCaptures:
          '1': {name: meta.function-call.nim_filter variable.function.nim_filter}
          '2': {name: keyword.operator.nim_filter}
          '3': {name: string.quoted.triple.nim_filter punctuation.definition.string.begin.nim_filter}
        end: '^(?! *#)|"""(?!")'
        endCaptures:
          '0': {name: string.quoted.triple.nim_filter punctuation.definition.string.end.nim_filter}
        contentName: string.quoted.triple.nim_filter
        patterns:
          - match: '{{|}}'
            name: constant.character.escape.nim_filter
          - begin: '{'
            beginCaptures:
              '0': {name: punctuation.section.embedded.begin.nim_filter}
            end: '^(?! *#)|(=?(?: *:[^}]*)?) *(})|(?="""[^"])'
            endCaptures:
              '1': {name: constant.other.format-spec.nim_filter}
              '2': {name: punctuation.section.embedded.end.nim_filter}
            name: meta.embedded.nim_filter
            patterns:
              - include: '#main'
      - begin: (fmt)(")
        beginCaptures:
          '1': {name: meta.function-call.nim_filter variable.function.nim_filter}
          '2': {name: string.quoted.double.nim_filter punctuation.definition.string.begin.nim_filter}
        end: ^(?! *#)|("(?!"))|(\n)
        endCaptures:
          '1': {name: string.quoted.double.nim_filter punctuation.definition.string.end.nim_filter}
          '2': {name: invalid.illegal.nim_filter}
        contentName: string.quoted.triple.nim_filter
        patterns:
          - match: '{{|}}|""'
            name: constant.character.escape.nim_filter
          - begin: '{'
            beginCaptures:
              '0': {name: punctuation.section.embedded.begin.nim_filter}
            end: '^(?! *#)|(=?(?: *:[^}]*)?) *(})|(\n)|(?=")'
            endCaptures:
              '1': {name: constant.other.format-spec.nim_filter}
              '2': {name: punctuation.section.embedded.end.nim_filter}
              '3': {name: invalid.illegal.nim_filter}
            name: meta.embedded.nim_filter
            patterns:
              - include: '#main'
      - begin: (&)(")
        beginCaptures:
          '1': {name: keyword.operator.nim_filter}
          '2': {name: string.quoted.double.nim_filter punctuation.definition.string.begin.nim_filter}
        end: ^(?! *#)|(")|(\n)
        endCaptures:
          '1': {name: string.quoted.double.nim_filter punctuation.definition.string.end.nim_filter}
          '2': {name: invalid.illegal.nim_filter}
        contentName: string.quoted.double.nim_filter
        patterns:
          - match: '{{|}}'
            name: constant.character.escape.nim_filter
          - begin: '{'
            beginCaptures:
              '0': {name: punctuation.section.embedded.begin.nim_filter}
            end: '^(?! *#)|(=?(?: *:[^}]*)?) *(})|(\n)|(?=")'
            endCaptures:
              '1': {name: constant.other.format-spec.nim_filter}
              '2': {name: punctuation.section.embedded.end.nim_filter}
              '3': {name: invalid.illegal.nim_filter}
            name: meta.embedded.nim_filter
            patterns:
              - match: '\\(?:[ABCEFLNPRTVabceflnprtv"''\\]|\d+|[Xx]\h{2}|[Uu](?:\h{4}|\{\h+}))'
                name: constant.character.escape.nim_filter
              - match: \\
                name: invalid.illegal.lone-escape.nim_filter
              - include: '#main'
          - match: '\\(?:[ABCEFLNPRTVabceflnprtv"''\\]|\d+|[Xx]\h{2}|[Uu](?:\h{4}|\{\h+}))'
            name: constant.character.escape.nim_filter
          - match: \\
            name: invalid.illegal.lone-escape.nim_filter

  type-defs:
    patterns:
      - begin: '^ *(type) +(?:(?:[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`) *(\.))?([A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`)(?: *(\*))?'
        beginCaptures:
          '1': {name: storage.modifier.nim_filter}
          '2': {name: punctuation.accessor.dot.nim_filter}
          '3': {name: entity.name.type.nim_filter}
          '4': {name: storage.modifier.nim_filter}
        end: ^(?! *#)|(?=[^\[ ])
        patterns:
          - include: '#generic-param-list'

      - begin: ^type\b
        beginCaptures:
          '0': {name: keyword.declaration.type.nim_filter}
        end: ^(?! *#)|^(?!  |$)
        patterns:
          - begin: '^  (?:(?:[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`) *(\.))?([A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`)(?: *(\*))?'
            beginCaptures:
              '1': {name: punctuation.accessor.dot.nim_filter}
              '2': {name: entity.name.type.nim_filter}
              '3': {name: storage.modifier.nim_filter}
            end: ^(?! *#)|(?![\[\s])
            patterns:
              - include: '#generic-param-list'
          - include: '#main'

  const-defs:
    patterns:
      - begin: \b(const) +(?=[A-Za-z\x80-\xff]|\(|`|_\b)
        beginCaptures:
          '1': {name: storage.modifier.nim_filter}
        end: '^(?! *#)|([A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`)(?: *(\*))?|(?=[^\(])'
        endCaptures:
          '1': {name: entity.name.constant.expl}
          '2': {name: storage.modifier.expl}
        patterns:
          - include: '#const-name'

      - begin: ^const\b
        beginCaptures:
          '0': {name: storage.modifier.nim_filter keyword.declaration.constant.nim_filter}
        end: ^(?! *#)|^(?!  |$)
        patterns:
          - begin: '^  (?=[A-Za-z\x80-\xff]|\(|`|_\b)'
            end: '^(?! *#)|([A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`)(?: *(\*))?|(?=[^\(])'
            endCaptures:
              '1': {name: entity.name.constant.expl}
              '2': {name: storage.modifier.expl}
            patterns:
              - include: '#const-name'
          - include: '#main'

  const-name:
    patterns:
      - begin: '\('
        beginCaptures:
          '0': {name: punctuation.section.parens.begin.nim_filter}
        end: '^(?! *#)|(\))|(?=[^{_`,#A-Za-z\x80-\xff\s])'
        endCaptures:
          '1': {name: punctuation.section.parens.end.nim_filter}
        patterns:
          - match: '([A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`)(?: *(\*))?'
            captures:
              '1': {name: entity.name.constant.expl}
              '2': {name: storage.modifier.expl}
          - match: ','
            name: punctuation.separator.nim_filter
          - include: '#pragmas'
          - include: '#doc-comments'
          - include: '#comments'

  var-let-using-defs:
    patterns:
      - begin: '(?:^|(;)) *(var|let|using) +(?=[\(`A-Za-z\x80-\xff]|_\b)'
        beginCaptures:
          '1': {name: punctuation.terminator.nim_filter}
          '2': {name: storage.modifier.nim_filter keyword.declaration.variable.nim_filter}
        end: '^(?! *#)|(?=[^\({_`,#A-Za-z\x80-\xff\s])'
        patterns:
          - include: '#var-name'

      - begin: ^(?:var|let|using)\b
        beginCaptures:
          '0': {name: storage.type.nim_filter}
        end: ^(?! *#)|^(?!  |$)
        patterns:
          - begin: ^  (?=[\(`A-Za-z\x80-\xff]|_\b)
            end: '^(?! *#)|(?=[^\({_`,#A-Za-z\x80-\xff\s])'
            patterns:
              - include: '#var-name'
          - include: '#main'

  var-name:
    patterns:
      - begin: '\('
        beginCaptures:
          '0': {name: punctuation.section.parens.begin.nim_filter}
        end: '^(?! *#)|(\))|(?=[^{_`,#A-Za-z\x80-\xff\s])'
        endCaptures:
          '1': {name: punctuation.section.parens.end.nim_filter}
        patterns:
          - include: '#var-name-0'
      - include: '#var-name-0'

  var-name-0:
    patterns:
      - match: '([A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`)(?: *(\*))?'
        captures:
          '1': {name: variable.other.expl}
          '2': {name: storage.modifier.expl}
      - match: ','
        name: punctuation.separator.nim_filter
      - include: '#pragmas'
      - include: '#doc-comments'
      - include: '#comments'

  generic-param-list:
    patterns:
      - begin: (?<=[`*\w\x{80}-\x{ff}]) *(\[)
        beginCaptures:
          '1': {name: punctuation.section.generic.begin.nim_filter}
        end: '^(?! *#)|(])|(?=[^#_`:=,;A-Za-z\x80-\xff\s])'
        endCaptures:
          '1': {name: punctuation.section.generic.end.nim_filter}
        name: meta.generic.nim_filter
        patterns:
          - include: '#generic-param-list-0'

  generic-param-list-0:
    patterns:
      - match: '[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`'
        name: variable.parameter.nim_filter
      - match: '[,;]'
        name: punctuation.separator.nim_filter
      - begin: '(:)|(=)'
        beginCaptures:
          '1': {name: punctuation.separator.annotation.nim_filter}
          '2': {name: keyword.operator.assignment.nim_filter}
        end: '^(?! *#)|([,;])|(?=\])'
        endCaptures:
          '1': {name: punctuation.separator.nim_filter}
        patterns:
          - include: '#main'
      - include: '#comments'

  pragmas:
    patterns:
      - begin: \{\.(?!\.})
        beginCaptures:
          '0': {name: punctuation.section.annotation.begin.nim_filter}
        end: '^(?! *#)|\.?}'
        endCaptures:
          '0': {name: punctuation.section.annotation.end.nim_filter}
        name: meta.annotation.nim_filter
        patterns:
          - match: '[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`'
            name: entity.other.attribute-name.pragma.nim_filter
          - include: '#square-brackets'
          - begin: (?=\S)
            end: '^(?! *#)|(,)|(?=\S)'
            endCaptures:
              '1': {name: punctuation.separator.sequence.nim_filter}
            patterns:
              - begin: ':'
                beginCaptures:
                  '0': {name: punctuation.separator.key-value.nim_filter}
                end: ^(?! *#)|(,)|(?=\.?})
                endCaptures:
                  '1': {name: punctuation.separator.sequence.nim_filter}
                patterns:
                  - include: '#main'

  operators:
    patterns:
      - match: '\b(?:and|not|x?or)\b'
        name: keyword.operator.logical.nim_filter
      - match: '\b(?:of|(?:not)?in|is(?:not)?)\b'
        name: keyword.operator.word.nim_filter
      - match: \bsh[lr]\b
        name: keyword.operator.bitwise.nim_filter
      - match: '\b(?:div|mod)\b'
        name: keyword.operator.arithmetic.nim_filter
      - match: '==|<=?|>=?|!='
        name: keyword.operator.comparison.nim_filter
      - match: '(?:[-+*/@$&%|^.:\\∙∘×★⊗⊘⊙⊛⊠⊡∩∧⊓±⊕⊖⊞⊟∪∨⊔][-=+*/<>@$~&%|!?^.:\\∙∘×★⊗⊘⊙⊛⊠⊡∩∧⊓±⊕⊖⊞⊟∪∨⊔]*)?=(?![-=+*/<>@$~&%|!?^.:\\∙∘×★⊗⊘⊙⊛⊠⊡∩∧⊓±⊕⊖⊞⊟∪∨⊔])'
        name: keyword.operator.assignment.nim_filter
      - match: '[-=+*/<>@$~&%|!?^.:\\∙∘×★⊗⊘⊙⊛⊠⊡∩∧⊓±⊕⊖⊞⊟∪∨⊔]+'
        name: keyword.operator.nim_filter

  literals:
    patterns:
      - include: '#str_lits'
      - include: '#numbers'
      - include: '#characters'
      - include: '#language-constants'

  str_lits:
    patterns:
      - include: '#triplestr_lit'
      - include: '#rstr_lit'
      - include: '#str_lit'

  triplestr_lit:
    patterns:
      - begin: '([Rr])?(""")'
        beginCaptures:
          '1': {name: storage.type.nim_filter}
          '2': {name: string.quoted.triple.nim_filter punctuation.definition.string.begin.nim_filter}
        end: '^(?! *#)|"""(?!")'
        endCaptures:
          '0': {name: string.quoted.triple.nim_filter punctuation.definition.string.end.nim_filter}
        contentName: string.quoted.triple.nim_filter

  rstr_lit:
    patterns:
      - begin: '([Rr])(")'
        beginCaptures:
          '1': {name: storage.type.nim_filter}
          '2': {name: string.quoted.double.nim_filter punctuation.definition.string.begin.nim_filter}
        end: '^(?! *#)|("(?!"))|(\n)'
        endCaptures:
          '1': {name: string.quoted.double.nim_filter punctuation.definition.string.end.nim_filter}
          '2': {name: string.quoted.double.nim_filter invalid.illegal.unclosed-string.nim_filter}
        contentName: string.quoted.double.nim_filter
        patterns:
          - match: '""'
            name: constant.character.escape.nim_filter

  str_lit:
    patterns:
      - begin: '"'
        beginCaptures:
          '0': {name: punctuation.definition.string.begin.nim_filter}
        end: '^(?! *#)|(")|(\n)'
        endCaptures:
          '1': {name: punctuation.definition.string.end.nim_filter}
          '2': {name: invalid.illegal.nim_filter}
        name: string.quoted.double.nim_filter
        patterns:
          - match: '\\(?:[ABCEFLNPRTVabceflnprtv"''\\]|\d+|[Xx]\h{2}|[Uu](?:\h{4}|\{\h+}))'
            name: constant.character.escape.nim_filter
          - match: \\
            name: invalid.illegal.lone-escape.nim_filter

  numbers:
    patterns:
      - match: '(?x:
          \b(\d(?:_?\d)*)
          (?:
            (?:
               ((\.)\d(?:_?\d)*)
               ([Ee][-+]?\d(?:_?\d)*)?
              |([Ee][-+]?\d(?:_?\d)*)
            )
             (''(?:[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_)|(?:[Ff](?:32|64)|[Dd]))?
            |(''(?:[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_)|(?:[Ff](?:32|64)|[Dd]))
          )
        )'
        captures:
          '0': {name: meta.number.float.decimal.nim_filter}
          '1': {name: constant.numeric.value.nim_filter}
          '2': {name: constant.numeric.value.nim_filter}
          '3': {name: punctuation.separator.decimal.nim_filter}
          '4': {name: constant.numeric.value.exponent.nim_filter}
          '5': {name: constant.numeric.value.exponent.nim_filter}
          '6': {name: constant.numeric.suffix.nim_filter}
          '7': {name: constant.numeric.suffix.nim_filter}

      - match: '(?x:
          \b(0[Xx])
          (\h(?:_?\h)*)
          (''(?:[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_)|[Ff](?:32|64))
        )'
        captures:
          '0': {name: meta.number.float.hexadecimal.nim_filter}
          '1': {name: constant.numeric.base.nim_filter}
          '2': {name: constant.numeric.value.nim_filter}
          '3': {name: constant.numeric.suffix.nim_filter}

      - match: '(?x:
          \b(0o)
          ([0-7](?:_?[0-7])*)
          (''(?:[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_)|(?:[Ff](?:32|64)|[Dd]))
        )'
        captures:
          '0': {name: meta.number.float.octal.nim_filter}
          '1': {name: constant.numeric.base.nim_filter}
          '2': {name: constant.numeric.value.nim_filter}
          '3': {name: constant.numeric.suffix.nim_filter}

      - match: '(?x:
          \b(0[Bb])
          ([01](?:_?[01])*)
          (''(?:[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_)|(?:[Ff](?:32|64)|[Dd]))
        )'
        captures:
          '0': {name: meta.number.float.binary.nim_filter}
          '1': {name: constant.numeric.base.nim_filter}
          '2': {name: constant.numeric.value.nim_filter}
          '3': {name: constant.numeric.suffix.nim_filter}


      - match: '(?x:
          \b(0[Xx])
          (\h(?:_?\h)*)
          (''(?:[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_)|(?:[IUiu](?:8|16|32|64)|[Uu]))?
        )'
        captures:
          '0': {name: meta.number.integer.hexadecimal.nim_filter}
          '1': {name: constant.numeric.base.nim_filter}
          '2': {name: constant.numeric.value.nim_filter}
          '3': {name: constant.numeric.suffix.nim_filter}

      - match: '(?x:
          \b(0o)
          ([0-7](?:_?[0-7])*)
          (''(?:[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_)|(?:[IUiu](?:8|16|32|64)|[Uu]))?
        )'
        captures:
          '0': {name: meta.number.integer.octal.nim_filter}
          '1': {name: constant.numeric.base.nim_filter}
          '2': {name: constant.numeric.value.nim_filter}
          '3': {name: constant.numeric.suffix.nim_filter}

      - match: '(?x:
          \b(0[Bb])
          ([01](?:_?[01])*)
          (''(?:[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_)|(?:[IUiu](?:8|16|32|64)|[Uu]))?
        )'
        captures:
          '0': {name: meta.number.integer.binary.nim_filter}
          '1': {name: constant.numeric.base.nim_filter}
          '2': {name: constant.numeric.value.nim_filter}
          '3': {name: constant.numeric.suffix.nim_filter}

      - match: '(?x:
          \b(\d(?:_?\d)*)
          (''(?:[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_)|(?:[IUiu](?:8|16|32|64)|[Uu]))?
        )'
        captures:
          '0': {name: meta.number.integer.decimal.nim_filter}
          '1': {name: constant.numeric.value.nim_filter}
          '2': {name: constant.numeric.suffix.nim_filter}

  characters:
    patterns:
      - match: '''(?:[^\\'']|(\\(?:[ABCEFLNRTVabceflnrtv"''\\]|\d+|[Xx]\h{2})))'''
        captures:
          '0': {name: constant.character.nim_filter}
          '1': {name: constant.character.escape.nim_filter}

      - match: '''[^'']+'''
        name: invalid.illegal.nim_filter

  language-constants:
    patterns:
      - match: '\b(?:true|false|nil)\b'
        name: constant.language.nim_filter

  keywords:
    patterns:
      - match: '\b(?:addr|cast)\b'
        name: keyword.operator.word.expl

      - begin: \bdiscard +"""
        beginCaptures:
          '0': {name: punctuation.definition.comment.begin.expl}
        end: '^(?! *#)|"""(?!")'
        endCaptures:
          '0': {name: punctuation.definition.comment.end.expl}
        name: comment.block.expl

      - match: '\b(?:distinct|discard)\b'
        name: keyword.other.expl

      - match: '\b(?:asm|end|break|continue|raise|return|yield)\b'
        name: keyword.control.flow.expl

      - match: \b(?:concept|enum|interface)\b
        name: storage.type.expl

      - match: '\b(object)\b(?: *(of)\b)?'
        captures:
          '1': {name: storage.type.expl}
          '2': {name: keyword.other.expl}

      - match: '\bwhile\b'
        name: keyword.control.loop.while.expl

      - match: '\bcase\b'
        name: keyword.control.conditional.switch.expl

      - match: '^ *(of)\b'
        name: keyword.control.conditional.case.expl

      - match: '\bif\b'
        name: keyword.control.conditional.if.expl

      - match: '\bwhen\b'
        name: keyword.control.conditional.when.expl

      - match: '\belif\b'
        name: keyword.control.conditional.elseif.expl

      - match: '\b(else)\b(?: *(:))?'
        captures:
          '0': {name: meta.statement.conditional.else.expl}
          '1': {name: keyword.control.conditional.else.expl}
          '2': {name: punctuation.section.block.conditional.else.expl}

      - match: '\b(try)\b(?: *(:))?'
        captures:
          '0': {name: meta.statement.exception.try.expl}
          '1': {name: keyword.control.exception.try.expl}
          '2': {name: punctuation.section.block.exception.expl}

      - match: '\b(finally)\b(?: *(:))?'
        captures:
          '0': {name: meta.statement.exception.finally.expl}
          '1': {name: keyword.control.exception.finally.expl}
          '2': {name: punctuation.section.block.exception.finally.expl}

      - match: '\b(defer)\b(?: *(:))?'
        captures:
          '1': {name: keyword.control.flow.defer.expl}
          '2': {name: punctuation.section.block.begin.expl}

      - match: '\b(block)\b(?:(?: *(?:[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`))? *(:))?'
        captures:
          '1': {name: keyword.declaration.block.expl}
          '2': {name: punctuation.section.block.begin.expl}

      - match: '\b(?:as|(?:ex|im)port|include|bind|mixin|from|except)\b'
        name: keyword.control.expl

      - match: '\b(?:const|let|using)\b'
        name: storage.modifier.expl keyword.declaration.expl

      - match: \bvar\b
        name: storage.modifier.expl

  do-stmts:
    patterns:
      - begin: \bdo\b
        beginCaptures:
          '0': {name: storage.type.function.nim_filter}
        end: '^(?! *#)|(->)|(?=[^\-\( ])'
        endCaptures:
          '1': {name: punctuation.separator.annotation.return.nim_filter}
        patterns:
          - include: '#param-list'

  calls:
    patterns:
      - begin: '(?x:
          (?=
            (?:
              (?!(?:out|ptr|ref|tuple)\b)
              [A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`
            )
            (?:\[.*])?
            (?:
              \(
              |"
              |[ ]+
              (?:
                [_\d"''`\[\(]
                |(?!\.|(?:\*?[ ]*)[:=]|=[^=])[-=+*/<>@$~&%|!?^.:\\∙∘×★⊗⊘⊙⊛⊠⊡∩∧⊓±⊕⊖⊞⊟∪∨⊔]+[^\-=+*/<>@$~&%|!?^.:\\∙∘×★⊗⊘⊙⊛⊠⊡∩∧⊓±⊕⊖⊞⊟∪∨⊔\s]
                |(?!as|asm|and|bind|break|concept|const|continue|converter
                  |defer|discard|distinct|div|elif|else|end|except|export|finally|from|import
                  |include|interface|is(?:not)?|let|macro|method|mixin|mod|(?:not)?in|of
                  |raise|sh[lr]|template|using|while|yield|x?or)[A-Za-z\x80-\xff]
                |\{(?!\.)
              )
            )
          )
        )'
        end: '^(?! *#)|(?=[^\[\(`\w\x{80}-\x{ff}])|(?<=["\)])'
        patterns:
          - begin: '(?=[`_A-Za-z\x80-\xff])'
            end: '^(?! *#)|(?=[^`_A-Za-z\x80-\xff])'
            name: variable.function.nim_filter
            patterns:
              - include: '#builtins'
              - match: '[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`'

          - begin: '\[:?'
            beginCaptures:
              '0': {name: punctuation.section.generic.begin.nim_filter}
            end: '^(?! *#)|]'
            endCaptures:
              '0': {name: punctuation.section.generic.end.nim_filter}
            name: meta.function-call.nim_filter meta.generic.nim_filter
            patterns:
              - include: '#main'
          - begin: '\('
            beginCaptures:
              '0': {name: punctuation.section.arguments.begin.nim_filter}
            end: ^(?! *#)|(\))
            endCaptures:
              '1': {name: punctuation.section.arguments.end.nim_filter}
            name: meta.function-call.arguments.nim_filter
            patterns:
              - match: '(?x:
                  (?=
                    (?:[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`)
                    [ ]*
                    [:=](?![-=+*/<>@$~&%|!?^.:\\∙∘×★⊗⊘⊙⊛⊠⊡∩∧⊓±⊕⊖⊞⊟∪∨⊔])
                  )
                  (?!(?x:addr|asm|bind|block|break|case|cast|concept|const|continue|converter
                    |defer|discard|distinct|do|elif|else|end|enum|except|export|finally|for
                    |from|func|if|import|include|interface|iterator|let|macro|method|mixin
                    |object|of|out|proc|ptr|raise|ref|return|static|template|try|tuple|type
                    |using|var|when|while|yield)\b
                  )
                  ([A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`)(?:[ ]*(:))?
                )'
                captures:
                  '1': {name: variable.parameter.nim_filter}
                  '2': {name: punctuation.separator.key-value.nim_filter}
              - include: '#main'
          - include: '#triplestr_lit'
          - begin: '"'
            beginCaptures:
              '0': {name: punctuation.definition.string.begin.nim_filter}
            end: '^(?! *#)|("(?!"))|(\n)'
            endCaptures:
              '1': {name: punctuation.definition.string.end.nim_filter}
              '2': {name: invalid.illegal.unclosed-string.nim_filter}
            name: string.quoted.double.nim_filter
            patterns:
              - match: '""'
                name: constant.character.escape.nim_filter

  types:
    patterns:
      - begin: \btuple(?=\[)
        beginCaptures:
          '0': {name: storage.type.primitive.nim_filter}
        end: ^(?! *#)|(?=[^\[ ])
        patterns:
          - include: '#generic-param-list'

      - begin: '(?=(?:[A-Za-z](?:_?[\dA-Za-z])*)\[)(?x:(out|ptr|ref|array
          |cstring[Aa]rray|iterable|lent|open[Aa]rray|owned|ptr|range|ref|se[qt]
          |sink|static|type(?:[Dd]esc)?|varargs)|([A-Z][\dA-Za-z]+))(\[)'
        beginCaptures:
          '1': {name: storage.type.primitive.nim_filter}
          '2': {name: support.type.nim_filter}
          '3': {name: meta.generic.nim_filter punctuation.section.generic.begin.nim_filter}
        end: '^(?! *#)|]'
        endCaptures:
          '0': {name: meta.generic.nim_filter punctuation.section.generic.nim_filter}
        contentName: meta.generic.nim_filter
        patterns:
          - include: '#main'

      - match: \b(?:out|tuple|ref|ptr)\b
        name: storage.type.primitive.expl

  builtins:
    patterns:
      - match: \bresult\b
        name: variable.language.nim_filter

      - match: '\b(?x:
          abs|add(?:[Ee]scapedChar|Float|Int|QuitProc|Quoted)?|alignof|allocCStringArray|arrayWith
          |ashr|astToStr|assert
          |atomic(?:AddFetch|AlwaysLockFree|(?:And|Nand|Or|Sub|Xor)Fetch|Clear
            |(?:Compare)?ExchangeN?|Dec|Fetch(?:A[dn]d|Nand|Or|Sub|Xor)|Inc
            |IsLockFree|LoadN?|(?:Signal|Thread)Fence|StoreN?|TestAndSet)
          |card|cas|chr|clamp|close|cmp(?:Mem)?|compile(?:Option|s)|contains|copyMem
          |cpuRelax|create(?:(?:Shared)?U?|Thread)|cstringArrayToSeq
          |dealloc(?:CStringArray|Heap|(?:Shared)?(?:Impl)?)|debugEcho|dec
          |declared(?:InScope)?|deepCopy|default|defined|del(?:ete)?|dispose|doAssert(?:Raises)?|echo|endOfFile
          |equalMem|excl|failedAssertImpl|field(?:s|Pairs)|find|finished|flushFile|freeShared
          |GC_(?:collectZct|disable(?:MarkAndSweep)?|fullCollect|getStatistics|(?:un)?ref)
          |gcInvariant|getAllocStats
          |get(?:CurrentException(?:Msg)?|File(?:Pos|Size)|Frame(?:State)?
            |(?:(?:Free|Occupied|Total)(?:Shared)?|Max)Mem|GCFrame|OsFileHandle
            |StackTrace(?:Entries)?|TypeInfo|ThreadId)
          |gorge(?:Ex)?|handle|high|incl?|insert|instantiationInfo|internalNew
          |isNil|isNotForeign|iterToProc|joinThreads?|len|lines|locals|low|max|min
          |m?(?:items|pairs)|move(?:Mem)?
          |new(?:Seq(?:OfCap|Uninitialized)?|String(?:OfCap)?|Exception|WideCString)?
          |onFailedAssert|onThreadDestruction|open|ord|peek|pinToCpu|pop(?:GcFrame)?|pred
          |prepareMutation|procCall|protect|pushGcFrame|quit|raiseAssert|raw(?:Env|Proc)
          |ready|read(?:All|Buffer|Bytes|Chars?|File|Lines?)
          |(?:re)?alloc(?:Shared)?0?(?:Impl)?|recv|repr(?:Discriminant)?|reset
          |resize(?:Shared)?|runnableExamples
          |set(?:ControlCHook|CurrentException|FilePos|Frame(?:State)?|GcFrame|Inheritable|Len|StdIoUnbuffered|upForeignThreadGc)
          |shallow(?:Copy)?|sizeof|slurp|stackTraceAvailable|static(?:Exec|Read)|stdmsg
          |substr|succ|swap|tearDownForeignThreadGc
          |to(?:Biggest?(?:Float|Int)|OpenArray(?:Byte)?|U(?:8|16|32))|try(?:Recv|Send)
          |typeof|unsafe(?:Addr|New)|unsetControlCHook|wasMoved|writeStackTrace
          |ze(?:64)?|zero(?:Default|Mem)|count(?:down|up)|varargsLen|closureScope
          |currentSourcePath|disarm|dumpAllocStats|excl|fence|format(?:ErrorIndexBound|FieldDefect)
          |incl|offsetOf|once|rangeCheck|(?:un)?likely|unown|write(?:Buffer|Bytes|Chars|File|Line)?
        )\b'
        name: support.function.builtin.expl

      - match: '`(?:addr|and|div|is(?:not)?|mod|not|of|sh[lr]|x?or|(?:not)?in|=(?:copy|destroy|sink|trace)|\$|%%|[-*+/<]%?=?|<=%|[&=]=?|\.\.|@|\[]=?)`'
        name: support.function.builtin.expl

      - match: '\b(?x:any|array|auto|bool|byte
          |c(?:double|float|u?(?:long(?:long)?|char|int|short)|longdouble|schar
            |size(?:_t)?|string(?:[Aa]rray)?)
          |char|float(?:32|64)?|iterable|lent|open[Aa]rray|owned|pointer|ptr|range|ref|se[qt]
          |sink|static|string|typed?|type[Dd]esc|u?int(?:8|16|32|64)?|untyped|varargs|void)\b'
        name: storage.type.primitive.expl

      - match: '\b(?x:appType|Compile(?:Date|Time)|(?:big|cpu|little)Endian
          |fm(Append|Read(?:Write(?:Existing)?)?|Write)|fsp(?:Set|Cur|End)
          |gc(?:Throughput|Responsiveness|Optimize(?:Space|Time))|host(?:CPU|OS)
          |isMainModule|NaN|(?:Neg)?Inf|Nim(?:Major|Minor|Patch|Version)|nimvm|off|on
          |Quit(?:Failure|Success)|typeOf(?:Iter|Proc))\b'
        name: support.constant.builtin.expl

      - match: '\b(?x:
          ATOMIC_(?:ACQ_REL|ACQUIRE|CONSUME|RELAXED|RELEASE|SEQ_CST)|errorMessageWriter
          |(?:global|local)RaiseHook|nimThreadDestructionHandlers|onUnhandledException
          |outOfMemHook|programResult|std(?:err|out|in)|unhandledExceptionHook
          )\b'
        name: support.variable.builtin.expl

  generic-symbols:
    patterns:
      - match: '[A-Z](_?[A-Z\d_])+\b'
        name: support.constant.expl
      - match: '[A-Z][\dA-Za-z]+\b'
        name: support.type.expl
      - match: '[A-Za-z\x80-\xff](?:_?[\dA-Za-z\x80-\xff])*|_|`[^;,\n`]+`'
